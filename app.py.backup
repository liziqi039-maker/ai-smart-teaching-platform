import os
import sys
import requests
from datetime import datetime
from pathlib import Path
from flask import Flask, jsonify, request
from flask_cors import CORS
from flask_jwt_extended import JWTManager

# ========== ä¿®å¤å¯¼å…¥è·¯å¾„ ==========
current_file = Path(__file__).resolve()
backend_dir = current_file.parent
project_root = backend_dir.parent
sys.path.insert(0, str(project_root))
# =================================

from config import config

# ========== å¯¼å…¥ç»Ÿä¸€çš„dbå®ä¾‹ ==========
try:
    from db_instance import db
    print("âœ… ä»db_instanceå¯¼å…¥ç»Ÿä¸€çš„dbå®ä¾‹")
except ImportError as e:
    print(f"âš ï¸  æ— æ³•å¯¼å…¥db_instance: {e}")
    # åˆ›å»ºä¸´æ—¶dbå®ä¾‹
    from flask_sqlalchemy import SQLAlchemy
    db = SQLAlchemy()
# =================================================


def create_app(config_name='default'):
    """åˆ›å»ºFlaskåº”ç”¨ - çº¯APIç‰ˆæœ¬"""
    app = Flask(__name__)

    # åŠ è½½é…ç½®
    app.config.from_object(config[config_name])
    
    # ========== AIæœåŠ¡é…ç½® ==========
    app.config.setdefault('AI_SERVICE_URL', 'http://localhost:3001/api/v1/ai')
    # =========================================

    # ========== CORSé…ç½® - å…è®¸å‰ç«¯3000ç«¯å£è®¿é—® ==========
    # æ·»åŠ æ›´å®½æ¾çš„CORSé…ç½®ï¼Œç¡®ä¿å‰ç«¯å¯ä»¥æ­£å¸¸è®¿é—®
    CORS(app, 
         resources={
             r"/api/*": {
                 "origins": ["http://localhost:3000", "http://127.0.0.1:3000", "http://localhost:3001"],
                 "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],
                 "allow_headers": ["Content-Type", "Authorization", "X-Requested-With", "X-Auth-Token", "Origin", "Accept"],
                 "expose_headers": ["Content-Type", "Authorization", "X-Requested-With"],
                 "supports_credentials": True,
                 "max_age": 3600
             },
             r"/*": {
                 "origins": ["http://localhost:3000", "http://127.0.0.1:3000"],
                 "methods": ["GET", "OPTIONS"],
                 "allow_headers": ["Content-Type"],
                 "supports_credentials": True
             }
         },
         supports_credentials=True)
    
    # ========== ä½¿ç”¨ç»Ÿä¸€çš„dbå®ä¾‹ ==========
    from flask_migrate import Migrate
    db.init_app(app)  # å°†ç»Ÿä¸€çš„dbå®ä¾‹ç»‘å®šåˆ°å½“å‰app
    migrate = Migrate(app, db)
    # ============================================================
    
    jwt = JWTManager(app)

    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    upload_folder = app.config.get('UPLOAD_FOLDER', 'backend/static/uploads')
    os.makedirs(upload_folder, exist_ok=True)
    os.makedirs('backend/static/videos', exist_ok=True)
    os.makedirs('backend/static/subtitles', exist_ok=True)
    os.makedirs('backend/static/frames', exist_ok=True)
    os.makedirs('database', exist_ok=True)
    os.makedirs('logs', exist_ok=True)

    # ========== åœ¨ä¸Šä¸‹æ–‡ä¸­å¯¼å…¥æ¨¡å‹ ==========
    with app.app_context():
        try:
            from models import User, Role, Permission, UserStats
            from models import Course, Video, Progress, Quiz, Note, Chapter
            print("âœ… æ¨¡å‹å¯¼å…¥æˆåŠŸ")
        except Exception as e:
            print(f"âš ï¸  æ¨¡å‹å¯¼å…¥è­¦å‘Š: {e}")
    # ===================================================

    # ========== æ³¨å†Œè“å›¾ ==========
    try:
        from routes.auth import auth_bp
        app.register_blueprint(auth_bp, url_prefix='/api/v1/auth')
        print("âœ… authè“å›¾æ³¨å†ŒæˆåŠŸ")
    except ImportError as e:
        print(f"è­¦å‘Š: æ— æ³•å¯¼å…¥ auth è·¯ç”±: {e}")
    
    try:
        from routes.user import user_bp
        app.register_blueprint(user_bp, url_prefix='/api/v1/users')
        print("âœ… userè“å›¾æ³¨å†ŒæˆåŠŸ")
    except ImportError as e:
        print(f"è­¦å‘Š: æ— æ³•å¯¼å…¥ user è·¯ç”±: {e}")
    
    try:
        from routes.quiz import quiz_bp
        app.register_blueprint(quiz_bp, url_prefix='/api/v1/quiz')
        print("âœ… quizè“å›¾æ³¨å†ŒæˆåŠŸ")
    except ImportError as e:
        print(f"è­¦å‘Š: æ— æ³•å¯¼å…¥ quiz è·¯ç”±: {e}")

    # ========== ç”¨æˆ·ç™»å½•çŠ¶æ€æ£€æŸ¥ ==========
    @app.route('/api/v1/auth/check', methods=['GET', 'OPTIONS'])
    def check_auth():
        """æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ - ç”¨äºå‰ç«¯å³ä¸Šè§’æ˜¾ç¤º"""
        if request.method == 'OPTIONS':
            return '', 200
        
        # è¿™é‡Œæš‚æ—¶è¿”å›æœªç™»å½•çŠ¶æ€ï¼Œå®é™…åº”è¯¥æ£€æŸ¥sessionæˆ–token
        # ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿæ•°æ®
        return jsonify({
            'success': True,
            'data': None,  # æœªç™»å½•æ—¶è¿”å›None
            'message': 'ç”¨æˆ·æœªç™»å½•'
        })

    # ========== ç®€åŒ–å¥åº·æ£€æŸ¥ç«¯ç‚¹ ==========
    @app.route('/api/v1/health', methods=['GET', 'OPTIONS'])
    def health_check():
        """ç®€åŒ–çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
        if request.method == 'OPTIONS':
            return '', 200
        
        return jsonify({
            'success': True,
            'message': 'APIæœåŠ¡å™¨è¿è¡Œæ­£å¸¸',
            'version': '1.0.0',
            'timestamp': datetime.now().isoformat()
        })
    
    # ========== APIè¿æ¥æµ‹è¯•ç«¯ç‚¹ ==========
    @app.route('/api/v1/test-connection', methods=['GET', 'OPTIONS'])
    def test_connection():
        """å‰ç«¯è°ƒç”¨æ­¤ç«¯ç‚¹æ¥æµ‹è¯•APIè¿æ¥"""
        if request.method == 'OPTIONS':
            return '', 200
            
        return jsonify({
            'success': True,
            'message': 'APIè¿æ¥æµ‹è¯•æˆåŠŸ',
            'timestamp': datetime.now().isoformat(),
            'frontend_origin': request.headers.get('Origin', 'unknown'),
            'cors_configured': True,
            'recommendations': [
                '1. ç¡®ä¿åç«¯è¿è¡Œåœ¨ http://localhost:8000',
                '2. å‰ç«¯è¿è¡Œåœ¨ http://localhost:3000',
                '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰CORSé”™è¯¯'
            ]
        })
    
    # ========== æ ¹è·¯å¾„ - é‡å®šå‘åˆ°å‰ç«¯ ==========
    @app.route('/')
    def index():
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>AIæ™ºæ…§æ•™å­¦å¹³å° - åç«¯APIæœåŠ¡</title>
            <meta http-equiv="refresh" content="0; url=http://localhost:3000">
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #2c7be5 0%, #1a5bb8 100%);
                    color: white;
                    height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0;
                }
                .container {
                    text-align: center;
                    max-width: 600px;
                    padding: 40px;
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }
                h1 {
                    font-size: 2.5rem;
                    margin-bottom: 20px;
                }
                p {
                    font-size: 1.1rem;
                    margin-bottom: 30px;
                    opacity: 0.9;
                }
                .btn {
                    display: inline-block;
                    background: white;
                    color: #2c7be5;
                    padding: 12px 30px;
                    border-radius: 50px;
                    text-decoration: none;
                    font-weight: 600;
                    margin: 10px;
                    transition: transform 0.3s, box-shadow 0.3s;
                }
                .btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
                }
                .spinner {
                    margin: 30px 0;
                    font-size: 3rem;
                }
                .links {
                    margin-top: 30px;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                }
                .api-link {
                    color: rgba(255, 255, 255, 0.8);
                    text-decoration: none;
                    padding: 8px 15px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    transition: all 0.3s;
                }
                .api-link:hover {
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                }
                .status {
                    padding: 10px 15px;
                    border-radius: 8px;
                    margin: 10px 0;
                    text-align: left;
                    font-family: monospace;
                    background: rgba(0, 0, 0, 0.2);
                }
                .success {
                    color: #4ade80;
                    border-left: 4px solid #4ade80;
                }
                .error {
                    color: #f87171;
                    border-left: 4px solid #f87171;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="spinner">ğŸ¤–</div>
                <h1>AIæ™ºæ…§æ•™å­¦å¹³å° - åç«¯API</h1>
                <p>APIæœåŠ¡è¿è¡Œä¸­ï¼Œæ­£åœ¨è·³è½¬åˆ°å‰ç«¯ç•Œé¢...</p>
                
                <div id="status" class="status">
                    <div>æ­£åœ¨æ£€æŸ¥APIè¿æ¥...</div>
                </div>
                
                <div>
                    <a href="http://localhost:3000" class="btn">
                        <i class="fas fa-external-link-alt"></i> ç«‹å³è®¿é—®å‰ç«¯
                    </a>
                    <a href="/api/v1/health" class="btn" style="background: rgba(255,255,255,0.1); color: white;">
                        <i class="fas fa-heartbeat"></i> æ£€æŸ¥APIçŠ¶æ€
                    </a>
                </div>
                
                <div class="links">
                    <h3>ğŸ“š APIç«¯ç‚¹ï¼š</h3>
                    <a href="/api/v1/health" class="api-link">GET /api/v1/health - å¥åº·æ£€æŸ¥</a>
                    <a href="/api/v1/test-connection" class="api-link">GET /api/v1/test-connection - è¿æ¥æµ‹è¯•</a>
                    <a href="/api/v1/auth/check" class="api-link">GET /api/v1/auth/check - ç”¨æˆ·ç™»å½•çŠ¶æ€</a>
                    <a href="/api/v1/quiz/questions" class="api-link">GET /api/v1/quiz/questions - è·å–é¢˜ç›®</a>
                    <a href="/api/v1/auth/login" class="api-link">POST /api/v1/auth/login - ç”¨æˆ·ç™»å½•</a>
                </div>
                
                <p style="margin-top: 30px; font-size: 0.9rem; opacity: 0.7;">
                    å¦‚æœé¡µé¢æ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æˆ–è®¿é—®ï¼š
                    <a href="http://localhost:3000" style="color: #00d2ff; text-decoration: none;">
                        http://localhost:3000
                    </a>
                </p>
            </div>
            
            <script>
                // æµ‹è¯•APIè¿æ¥
                async function testApi() {
                    const statusDiv = document.getElementById('status');
                    try {
                        const response = await fetch('/api/v1/health', {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            statusDiv.innerHTML = `
                                <div class="success">âœ… APIè¿æ¥æˆåŠŸ</div>
                                <div>åç«¯çŠ¶æ€: ${data.message}</div>
                                <div>ç‰ˆæœ¬: ${data.version}</div>
                                <div>æ—¶é—´: ${new Date(data.timestamp).toLocaleString()}</div>
                            `;
                            console.log('APIè¿æ¥æµ‹è¯•æˆåŠŸ:', data);
                        } else {
                            statusDiv.innerHTML = `
                                <div class="error">âŒ APIè¿æ¥å¤±è´¥ (${response.status})</div>
                                <div>çŠ¶æ€: ${response.statusText}</div>
                            `;
                            console.error('APIè¿æ¥æµ‹è¯•å¤±è´¥:', response.status, response.statusText);
                        }
                    } catch (error) {
                        statusDiv.innerHTML = `
                            <div class="error">âŒ APIè¿æ¥é”™è¯¯</div>
                            <div>é”™è¯¯: ${error.message}</div>
                            <div>è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨</div>
                        `;
                        console.error('APIè¿æ¥é”™è¯¯:', error);
                    }
                }
                
                // é¡µé¢åŠ è½½åæµ‹è¯•API
                document.addEventListener('DOMContentLoaded', testApi);
                
                // 3ç§’åè‡ªåŠ¨è·³è½¬
                setTimeout(() => {
                    window.location.href = 'http://localhost:3000';
                }, 3000);
            </script>
        </body>
        </html>
        '''
    
    # ========== AIæœåŠ¡ç½‘å…³ ==========
    @app.route('/api/v1/ai/<path:ai_path>', methods=['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'])
    def ai_gateway(ai_path):
        """
        AIæœåŠ¡ç½‘å…³ï¼šè½¬å‘è¯·æ±‚åˆ°ç‹¬ç«‹çš„AIæœåŠ¡
        å‰ç«¯è°ƒç”¨ /api/v1/ai/* -> è½¬å‘åˆ° http://localhost:3001/api/v1/ai/*
        """
        if request.method == 'OPTIONS':
            return '', 200
            
        try:
            # æ„å»ºç›®æ ‡URL
            ai_service_url = app.config.get('AI_SERVICE_URL', 'http://localhost:3001/api/v1/ai')
            target_url = f"{ai_service_url}/{ai_path}"
            
            # è·å–è¯·æ±‚æ•°æ®
            data = request.get_json(silent=True) or request.form.to_dict()
            
            # è½¬å‘è¯·æ±‚å¤´ï¼ˆç§»é™¤ä¸å¿…è¦çš„å†…å®¹ï¼‰
            headers = {key: value for key, value in request.headers 
                      if key.lower() not in ['host', 'content-length']}
            
            # æ·»åŠ å¿…è¦çš„CORSå¤´
            headers['Origin'] = 'http://localhost:8000'
            
            # è½¬å‘è¯·æ±‚åˆ°AIæœåŠ¡
            response = requests.request(
                method=request.method,
                url=target_url,
                json=data if request.is_json else None,
                data=None if request.is_json else data,
                headers=headers,
                timeout=30
            )
            
            # è¿”å›AIæœåŠ¡çš„å“åº”
            return jsonify(response.json()), response.status_code
            
        except requests.exceptions.ConnectionError:
            return jsonify({
                'success': False,
                'message': 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿AIæœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£3001ï¼‰',
                'fallback': True,
                'mock': True,
                'timestamp': datetime.now().isoformat()
            }), 503
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'AIæœåŠ¡è¯·æ±‚å¤±è´¥: {str(e)}',
                'timestamp': datetime.now().isoformat()
            }), 500
    
    # ========== é”™è¯¯å¤„ç† ==========
    @app.errorhandler(404)
    def not_found(error):
        # å¦‚æœæ˜¯APIè¯·æ±‚ï¼Œè¿”å›JSONé”™è¯¯
        if request.path.startswith('/api/'):
            return jsonify({
                'success': False,
                'message': 'APIæ¥å£ä¸å­˜åœ¨',
                'path': request.path,
                'timestamp': datetime.now().isoformat(),
                'available_endpoints': {
                    'health': '/api/v1/health',
                    'auth_check': '/api/v1/auth/check',
                    'test_connection': '/api/v1/test-connection',
                    'auth': '/api/v1/auth/*',
                    'users': '/api/v1/users/*',
                    'quiz': '/api/v1/quiz/*',
                    'ai': '/api/v1/ai/*'
                }
            }), 404
        # å¦åˆ™é‡å®šå‘åˆ°å‰ç«¯
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>é¡µé¢æœªæ‰¾åˆ° - AIæ™ºæ…§æ•™å­¦å¹³å°</title>
            <meta http-equiv="refresh" content="3; url=http://localhost:3000">
            <style>
                body {
                    font-family: Arial, sans-serif;
                    text-align: center;
                    padding: 50px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    height: 100vh;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                }
                h1 {
                    font-size: 3rem;
                    margin-bottom: 20px;
                }
                p {
                    font-size: 1.2rem;
                    margin-bottom: 30px;
                    opacity: 0.9;
                }
                a {
                    color: #00d2ff;
                    text-decoration: none;
                    font-weight: bold;
                    padding: 10px 20px;
                    border: 2px solid #00d2ff;
                    border-radius: 25px;
                    transition: all 0.3s;
                }
                a:hover {
                    background: #00d2ff;
                    color: white;
                }
            </style>
        </head>
        <body>
            <h1>404 - é¡µé¢æœªæ‰¾åˆ°</h1>
            <p>æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ï¼Œæ­£åœ¨è·³è½¬åˆ°å‰ç«¯é¦–é¡µ...</p>
            <a href="http://localhost:3000">ç«‹å³å‰å¾€</a>
            <script>
                setTimeout(() => {
                    window.location.href = 'http://localhost:3000';
                }, 3000);
            </script>
        </body>
        </html>
        ''', 404

    @app.errorhandler(500)
    def internal_error(error):
        # ä½¿ç”¨ç»Ÿä¸€çš„dbå®ä¾‹
        db.session.rollback()
        return jsonify({
            'success': False,
            'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
            'timestamp': datetime.now().isoformat(),
            'error': str(error) if app.config.get('DEBUG', False) else None
        }), 500
    
    @app.errorhandler(Exception)
    def handle_exception(error):
        # å¤„ç†æ‰€æœ‰æœªæ•è·çš„å¼‚å¸¸
        if request.path.startswith('/api/'):
            return jsonify({
                'success': False,
                'message': 'æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯',
                'timestamp': datetime.now().isoformat(),
                'error': str(error) if app.config.get('DEBUG', False) else None
            }), 500
        return f"æœåŠ¡å™¨é”™è¯¯: {str(error)}", 500

    return app


if __name__ == '__main__':
    # è·å–é…ç½®ç¯å¢ƒ
    config_name = os.getenv('FLASK_ENV', 'development')
    app = create_app(config_name)

    # å¯åŠ¨åº”ç”¨
    print("\n" + "="*60)
    print("ğŸ¤– AIæ™ºæ…§æ•™å­¦å¹³å° - çº¯APIåç«¯æœåŠ¡")
    print("="*60)
    print(f"ğŸ“ é¡¹ç›®æ ¹ç›®å½•: {project_root}")
    print(f"ğŸ“ åç«¯ç›®å½•: {backend_dir}")
    print("="*60)
    
    port = app.config.get('BACKEND_PORT', 8000)
    host = app.config.get('BACKEND_HOST', '127.0.0.1')
    debug_mode = app.config.get('DEBUG', True)
    
    print(f"ğŸš€ åç«¯APIåœ°å€: http://{host}:{port}")
    print(f"ğŸ”— å‰ç«¯è®¿é—®åœ°å€: http://localhost:3000")
    print(f"ğŸ¤– AIæœåŠ¡åœ°å€: http://localhost:3001")
    print(f"ğŸ› è°ƒè¯•æ¨¡å¼: {debug_mode}")
    print("="*60)
    print("ğŸ“š æ ¸å¿ƒAPIç«¯ç‚¹:")
    print(f"  - å¥åº·æ£€æŸ¥: http://{host}:{port}/api/v1/health")
    print(f"  - ç”¨æˆ·çŠ¶æ€æ£€æŸ¥: http://{host}:{port}/api/v1/auth/check")
    print(f"  - è¿æ¥æµ‹è¯•: http://{host}:{port}/api/v1/test-connection")
    print(f"  - ç”¨æˆ·è®¤è¯: http://{host}:{port}/api/v1/auth/login")
    print(f"  - é¢˜åº“API: http://{host}:{port}/api/v1/quiz/questions")
    print(f"  - AIæœåŠ¡ç½‘å…³: http://{host}:{port}/api/v1/ai/*")
    print("="*60)
    print("ğŸ’¡ æç¤º:")
    print("  1. å‰ç«¯é¡µé¢è¯·è®¿é—® http://localhost:3000")
    print("  2. æ‰€æœ‰å‰ç«¯è·¯ç”±ç”±å‰ç«¯æœåŠ¡å™¨å¤„ç†")
    print("  3. åç«¯åªå¤„ç† /api/* è¯·æ±‚")
    print("  4. å¦‚é‡CORSé”™è¯¯ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°")
    print("="*60 + "\n")
    
    print("ğŸ” æµ‹è¯•è¿æ¥å‘½ä»¤:")
    print(f"  curl http://{host}:{port}/api/v1/health")
    print(f"  curl http://{host}:{port}/api/v1/auth/check")
    print(f"  æˆ–")
    print(f"  Invoke-RestMethod -Uri 'http://{host}:{port}/api/v1/health' -Method GET")
    print("="*60 + "\n")

    app.run(
        host=host,
        port=port,
        debug=debug_mode,
        use_reloader=True
    )